generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Enums
// =============================================================================

enum RecordType {
  GENERIC
  PURCHASE_ORDER
  INVENTORY_ITEM
  INVOICE
  SHIPMENT
  TICKET
  RETURN
}

enum RecordStatus {
  OPEN
  DONE
  BLOCKED
  ARCHIVED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum PriorityLevel {
  LOW
  MEDIUM
  HIGH
}

enum SourceSystem {
  CSV
  ODOO
  SALESFORCE
  SAP
  EMAIL
  MANUAL
}

enum Channel {
  EMAIL
  PHONE
  SMS
  WHATSAPP
}

enum ItemStatus {
  PENDING
  RECEIVED
  BACKORDERED
  CANCELLED
}

enum WorkflowStatus {
  IDLE
  RUNNING
  WAITING_RESPONSE
  WAITING_HUMAN
  COMPLETED
}

// =============================================================================
// Models
// =============================================================================

model Record {
  id            String      @id @default(uuid())
  workspaceId   String      @map("workspace_id")
  type          RecordType  @default(GENERIC) @map("type")
  title         String      @map("title")
  status        RecordStatus @default(OPEN) @map("status")
  risk          RiskLevel?  @map("risk")
  priority      PriorityLevel? @map("priority")
  contactId     String?    @map("contact_id")
  dueAt         DateTime?  @map("due_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  sourceSystem  SourceSystem @map("source_system")
  sourceRecordId String?    @map("source_record_id")
  metadata      Json?       @map("metadata")
  rawData       Json?       @map("raw_data")
  workflowStatus WorkflowStatus? @map("workflow_status")

  // Relations
  contact       Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)
  recordWorkflows RecordWorkflow[]
  items         Item[]

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([contactId])
  @@index([sourceSystem, sourceRecordId])
  @@index([workflowStatus])
  @@map("records")
}

model Contact {
  id                    String                @id @default(uuid())
  workspaceId            String               @map("workspace_id")
  name                  String                @map("name")
  email                 String?               @map("email")
  phone                 String?               @map("phone")
  preferredChannel      Channel               @map("preferred_contact_method")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  records               Record[]

  @@index([workspaceId])
  @@index([email])
  @@index([phone])
  @@map("contacts")
}

model Workflow {
  id            String   @id @default(uuid())
  workspaceId   String   @map("workspace_id")
  name          String   @map("name")
  description   String?  @map("description") @db.Text
  model         String?  @map("model")
  systemPrompt  String?  @map("system_prompt") @db.Text
  temperature   Float?   @map("temperature")
  tools         Json?    @map("tools")
  schedule      String?  @map("schedule")
  emailTemplate   String?  @map("email_template") @db.Text
  callPrompt      String?  @map("call_prompt") @db.Text
  graphDefinition Json?    @map("graph_definition")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  recordWorkflows  RecordWorkflow[]
  schedulerRules   WorkflowSchedulerRules?

  @@index([workspaceId])
  @@map("workflows")
}

model WorkflowSchedulerRules {
  id                       String   @id @default(uuid())
  workflowId               String   @unique @map("workflow_id")

  // Timing rules
  minDaysBetweenActions    Int      @default(3) @map("min_days_between_actions")
  maxActionAttempts        Int      @default(5) @map("max_action_attempts")
  recordTooRecentDays      Int      @default(1) @map("record_too_recent_days")
  recentUpdateCooldownDays Int      @default(1) @map("recent_update_cooldown_days")
  escalationThreshold      Int      @default(3) @map("escalation_threshold")

  // Priority overrides
  highPriorityMinDays      Int      @default(1) @map("high_priority_min_days")
  lowPriorityMultiplier    Float    @default(2) @map("low_priority_multiplier")

  // Filters
  enabledStatuses          Json     @default("[\"OPEN\"]") @map("enabled_statuses")
  batchSize                Int      @default(50) @map("batch_size")

  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  workflow                 Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_scheduler_rules")
}

model RecordWorkflow {
  id        String   @id @default(uuid())
  recordId  String   @map("record_id")
  workflowId String  @map("workflow_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  workflow  Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([recordId, workflowId])
  @@index([recordId])
  @@index([workflowId])
  @@map("record_workflows")
}

model Item {
  id          String      @id @default(uuid())
  recordId    String      @map("record_id")
  name        String      @map("name")
  status      ItemStatus  @default(PENDING) @map("status")
  metadata    Json?       @map("metadata")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  record      Record      @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([status])
  @@map("items")
}
