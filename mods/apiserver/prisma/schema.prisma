generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// Enums
// =============================================================================

enum RecordType {
  GENERIC
  PURCHASE_ORDER
  INVENTORY_ITEM
  INVOICE
  SHIPMENT
  TICKET
  RETURN
}

enum RecordStatus {
  OPEN
  DONE
  BLOCKED
  ARCHIVED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum PriorityLevel {
  LOW
  MEDIUM
  HIGH
}

enum SourceSystem {
  CSV
  ODOO
  SALESFORCE
  SAP
  EMAIL
  MANUAL
}

enum Channel {
  EMAIL
  PHONE
  SMS
  WHATSAPP
}

enum ItemStatus {
  PENDING
  RECEIVED
  BACKORDERED
  CANCELLED
}

enum WorkflowRunStatus {
  PENDING
  RUNNING
  INTERRUPTED
  COMPLETED
  FAILED
}

// =============================================================================
// Models
// =============================================================================

model Record {
  id            String      @id @default(uuid())
  workspaceId   String      @map("workspace_id")
  type          RecordType  @default(GENERIC) @map("type")
  title         String      @map("title")
  status        RecordStatus @default(OPEN) @map("status")
  risk          RiskLevel?  @map("risk")
  priority      PriorityLevel? @map("priority")
  contactId     String?    @map("contact_id")
  dueAt         DateTime?  @map("due_at")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  sourceSystem  SourceSystem @map("source_system")
  sourceRecordId String?    @map("source_record_id")
  metadata      Json?       @map("metadata")
  rawData       Json?       @map("raw_data")

  // Relations
  contact       Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)
  history       RecordHistory[]
  recordWorkflows RecordWorkflow[]
  items         Item[]
  workflowRuns  WorkflowRun[]

  @@index([workspaceId])
  @@index([type])
  @@index([status])
  @@index([contactId])
  @@index([sourceSystem, sourceRecordId])
  @@map("records")
}

model RecordHistory {
  id              String      @id @default(uuid())
  recordId        String      @map("record_id")
  status          RecordStatus @map("status")
  aiNote          String?     @map("ai_note") @db.Text
  humanNote       String?     @map("human_note") @db.Text
  agent           String      @map("agent")
  channel         Channel     @map("channel")
  channelMetadata Json?       @map("channel_metadata")
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  record          Record      @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([createdAt])
  @@map("record_history")
}

model Contact {
  id                    String                @id @default(uuid())
  workspaceId            String               @map("workspace_id")
  name                  String                @map("name")
  email                 String?               @map("email")
  phone                 String?               @map("phone")
  preferredChannel      Channel               @map("preferred_contact_method")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  records               Record[]

  @@index([workspaceId])
  @@index([email])
  @@index([phone])
  @@map("contacts")
}

model Workflow {
  id            String   @id @default(uuid())
  workspaceId   String   @map("workspace_id")
  name          String   @map("name")
  description   String?  @map("description") @db.Text
  model         String?  @map("model")
  systemPrompt  String?  @map("system_prompt") @db.Text
  temperature   Float?   @map("temperature")
  tools         Json?    @map("tools")
  schedule      String?  @map("schedule")
  emailTemplate String?  @map("email_template") @db.Text
  callPrompt    String?  @map("call_prompt") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  recordWorkflows  RecordWorkflow[]
  schedulerRules   WorkflowSchedulerRules?

  @@index([workspaceId])
  @@map("workflows")
}

model WorkflowSchedulerRules {
  id                       String   @id @default(uuid())
  workflowId               String   @unique @map("workflow_id")

  // Timing rules
  minDaysBetweenActions    Int      @default(3) @map("min_days_between_actions")
  maxActionAttempts        Int      @default(5) @map("max_action_attempts")
  recordTooRecentDays      Int      @default(1) @map("record_too_recent_days")
  recentUpdateCooldownDays Int      @default(1) @map("recent_update_cooldown_days")
  escalationThreshold      Int      @default(3) @map("escalation_threshold")

  // Priority overrides
  highPriorityMinDays      Int      @default(1) @map("high_priority_min_days")
  lowPriorityMultiplier    Float    @default(2) @map("low_priority_multiplier")

  // Filters
  enabledStatuses          Json     @default("[\"OPEN\"]") @map("enabled_statuses")
  batchSize                Int      @default(50) @map("batch_size")

  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  // Relations
  workflow                 Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_scheduler_rules")
}

model RecordWorkflow {
  id        String   @id @default(uuid())
  recordId  String   @map("record_id")
  workflowId String  @map("workflow_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  record    Record   @relation(fields: [recordId], references: [id], onDelete: Cascade)
  workflow  Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([recordId, workflowId])
  @@index([recordId])
  @@index([workflowId])
  @@map("record_workflows")
}

model Item {
  id          String      @id @default(uuid())
  recordId    String      @map("record_id")
  name        String      @map("name")
  status      ItemStatus  @default(PENDING) @map("status")
  metadata    Json?       @map("metadata")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  record      Record      @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([status])
  @@map("items")
}

// =============================================================================
// LangGraph Workflow Runs (separate from existing LLM workflows)
// =============================================================================

model WorkflowRun {
  id            String            @id @default(uuid())
  workspaceId   String            @map("workspace_id")
  recordId      String            @map("record_id")
  configName    String            @map("config_name")
  threadId      String            @default(uuid()) @map("thread_id")
  status        WorkflowRunStatus @default(PENDING)
  initialData   Json?             @map("initial_data")
  errorMessage  String?           @map("error_message") @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")
  startedAt     DateTime?         @map("started_at")
  completedAt   DateTime?         @map("completed_at")

  // Relations
  record        Record            @relation(fields: [recordId], references: [id], onDelete: Cascade)
  callRefMappings CallRefMapping[]

  @@index([workspaceId])
  @@index([status])
  @@index([recordId])
  @@index([threadId])
  @@map("workflow_runs")
}

model CallRefMapping {
  callRef       String      @id @map("call_ref")
  threadId      String      @map("thread_id")
  workflowRunId String      @map("workflow_run_id")
  createdAt     DateTime    @default(now()) @map("created_at")

  // Relations
  workflowRun   WorkflowRun @relation(fields: [workflowRunId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@map("call_ref_mapping")
}

// =============================================================================
// LangGraph Checkpoint Tables (managed by @langchain/langgraph-checkpoint-postgres)
// These tables are created/managed by LangGraph but declared here to prevent
// Prisma drift detection warnings.
// =============================================================================

model Checkpoint {
  threadId   String   @map("thread_id")
  checkpoint String   @db.Text
  metadata   String?  @db.Text
  parentId   String?  @map("parent_id")
  createdAt  DateTime @default(now()) @map("created_at")

  @@id([threadId])
  @@map("checkpoints")
  @@ignore
}

model CheckpointBlob {
  threadId  String   @map("thread_id")
  channel   String
  version   String
  type      String
  blob      Bytes?
  createdAt DateTime @default(now()) @map("created_at")

  @@id([threadId, channel, version])
  @@map("checkpoint_blobs")
  @@ignore
}

model CheckpointWrite {
  threadId      String   @map("thread_id")
  checkpointNs  String   @map("checkpoint_ns")
  checkpointId  String   @map("checkpoint_id")
  taskId        String   @map("task_id")
  idx           Int
  channel       String
  type          String?
  blob          Bytes?
  createdAt     DateTime @default(now()) @map("created_at")

  @@id([threadId, checkpointNs, checkpointId, taskId, idx])
  @@map("checkpoint_writes")
  @@ignore
}

model CheckpointMigration {
  version   Int      @id
  createdAt DateTime @default(now()) @map("created_at")

  @@map("checkpoint_migrations")
  @@ignore
}
